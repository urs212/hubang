<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CCTV ì°¨ëŸ‰ ê°ì§€ ì‹œìŠ¤í…œ</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: black;
            color: lime;
            text-align: center;
        }
        #container {
            position: relative;
            width: 80%;
            margin: auto;
            max-width: 800px;
        }
        video {
            width: 100%;
            border: 5px solid lime;
        }
        .overlay {
            position: absolute;
            color: lime;
            background: rgba(0, 0, 0, 0.7);
            padding: 5px;
            font-size: 18px;
            border-radius: 5px;
        }
        #time {
            top: 10px;
            left: 10px;
        }
        #speed {
            bottom: 10px;
            left: 10px;
        }
        #alert {
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
            font-weight: bold;
            background: red;
            padding: 10px 20px;
            display: none;
        }
        #cameraSelect {
            margin-top: 10px;
            padding: 5px;
            font-size: 16px;
        }
    </style>
</head>
<body>

    <h1>CCTV ì°¨ëŸ‰ ê°ì§€ ì‹œìŠ¤í…œ</h1>

    <select id="cameraSelect"></select>
    
    <div id="container">
        <video id="video" autoplay></video>
        <div id="time" class="overlay"></div>
        <div id="speed" class="overlay">ğŸ“¡ ì†ë„: ìœ„ì¹˜ ì •ë³´ ê°€ì ¸ì˜¤ëŠ” ì¤‘...</div>
        <div id="alert" class="overlay">ğŸš¨ ì°¨ëŸ‰ ê°ì§€ë¨! ğŸš¨</div>
    </div>

    <script>
        let model;
        let currentStream;

        // ì¹´ë©”ë¼ ì‹œì‘ (ì‚¬ìš©ì ì„ íƒ)
        async function startCamera(deviceId = null) {
            try {
                if (currentStream) {
                    currentStream.getTracks().forEach(track => track.stop());
                }

                const constraints = { video: deviceId ? { deviceId: { exact: deviceId } } : true };
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                currentStream = stream;

                const videoElement = document.getElementById('video');
                videoElement.srcObject = stream;
                videoElement.onloadeddata = () => detectObjects();
            } catch (err) {
                alert("ì¹´ë©”ë¼ ì ‘ê·¼ ë¶ˆê°€: " + err);
            }
        }

        // ì¹´ë©”ë¼ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
        async function loadCameraOptions() {
            const devices = await navigator.mediaDevices.enumerateDevices();
            const videoDevices = devices.filter(device => device.kind === 'videoinput');

            const selectElement = document.getElementById('cameraSelect');
            selectElement.innerHTML = videoDevices.map((device, index) => 
                `<option value="${device.deviceId}">${device.label || `ì¹´ë©”ë¼ ${index + 1}`}</option>`
            ).join('');

            selectElement.addEventListener('change', (event) => {
                startCamera(event.target.value);
            });

            if (videoDevices.length > 0) {
                startCamera(videoDevices[0].deviceId);
            }
        }

        // ë‚ ì§œ ë° ì‹œê°„ ì—…ë°ì´íŠ¸
        function updateDateTime() {
            const now = new Date();
            document.getElementById('time').innerText = `ğŸ“… ${now.toLocaleDateString()} ${now.toLocaleTimeString()}`;
        }

        // GPS ê¸°ë°˜ ì†ë„ ì—…ë°ì´íŠ¸
        function updateSpeed(position) {
            if (position.coords.speed !== null) {
                const speedKmh = (position.coords.speed * 3.6).toFixed(1); // m/s â†’ km/h ë³€í™˜
                document.getElementById('speed').innerText = `ğŸš— ì†ë„: ${speedKmh} km/h`;
            } else {
                document.getElementById('speed').innerText = "ğŸ“¡ ì†ë„: ì¸¡ì • ë¶ˆê°€";
            }
        }

        // GPS ìœ„ì¹˜ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        function getGPS() {
            if ("geolocation" in navigator) {
                navigator.geolocation.watchPosition(updateSpeed, error => {
                    document.getElementById('speed').innerText = "ğŸ“¡ GPS ì˜¤ë¥˜";
                }, { enableHighAccuracy: true });
            } else {
                document.getElementById('speed').innerText = "ğŸ“¡ GPS ì§€ì› ì•ˆë¨";
            }
        }

        // ê°ì²´ ê°ì§€ (TensorFlow COCO-SSD)
        async function detectObjects() {
            if (!model) {
                model = await cocoSsd.load();
            }

            const videoElement = document.getElementById('video');
            const predictions = await model.detect(videoElement);

            let vehicleDetected = false;

            predictions.forEach(prediction => {
                const detectedObject = prediction.class;
                if (["car", "bus", "motorcycle"].includes(detectedObject)) {
                    vehicleDetected = true;
                }
            });

            const alertBox = document.getElementById('alert');
            if (vehicleDetected) {
                alertBox.style.display = "block";
                setTimeout(() => { alertBox.style.display = "none"; }, 3000);
            }

            requestAnimationFrame(detectObjects);
        }

        setInterval(updateDateTime, 1000);  // 1ì´ˆë§ˆë‹¤ ì‹œê°„ ê°±ì‹ 
        setTimeout(getGPS, 500);           // 0.5ì´ˆ í›„ GPS ì‹œì‘
        loadCameraOptions();               // ì¹´ë©”ë¼ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°

    </script>

</body>
</html>
